services:
  postgresql:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temporal -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  elasticsearch:
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=1s"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  worker:
    build:
      context: ../worker
      dockerfile: Dockerfile
    env_file:
      - "../worker/.env.example"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=cms-orchestration-dev
      - WORKFLOW_TASK_QUEUE=cms.workflow.queue
      - ACTIVITY_TASK_QUEUE=cms.activity.queue
    depends_on:
      - temporal
    command: ['npm','run','start:worker']
    volumes:
      - ../worker:/app
      - worker-node-modules:/app/node_modules
    networks:
      - temporal-network

  rest-proxy:
    build:
      context: ../worker
      dockerfile: Dockerfile
    env_file:
      - "../worker/.env.example"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=cms-orchestration-dev
      - WORKFLOW_TASK_QUEUE=cms.workflow.queue
    depends_on:
      - temporal
    command: ['npm','run','start:proxy']
    ports:
      - '4000:4000'
    volumes:
      - ../worker:/app
      - worker-node-modules:/app/node_modules
    networks:
      - temporal-network

  drupal-db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=drupalroot
      - MYSQL_DATABASE=drupal
      - MYSQL_USER=drupal
      - MYSQL_PASSWORD=drupal
    volumes:
      - drupal-db-data:/var/lib/mysql
      - ./drupal-db/my.cnf:/etc/mysql/conf.d/disable-ssl.cnf
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-pdrupalroot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - temporal-network

  drupal:
    build:
      context: ..
      dockerfile: drupal-cms/Dockerfile
    ports:
      - '8082:80'
    environment:
      - TEMPORAL_REST_URL=http://rest-proxy:4000
      - DRUPAL_DB_HOST=drupal-db
      - DRUPAL_DB_NAME=drupal
      - DRUPAL_DB_USER=drupal
      - DRUPAL_DB_PASSWORD=drupal
      - DRUPAL_DB_PORT=3306
      - DRUPAL_SITE_NAME=Temporal CMS Demo
      - DRUPAL_ADMIN_USER=admin
      - DRUPAL_ADMIN_PASSWORD=admin
      - DRUPAL_ADMIN_EMAIL=admin@example.com
    depends_on:
      drupal-db:
        condition: service_healthy
    volumes:
      - ../drupal/modules/custom/temporal_cms:/var/www/html/modules/custom/temporal_cms
      - ./drupal-apache.conf:/etc/apache2/conf-enabled/servername.conf
    networks:
      - temporal-network

  wordpress-db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=wordpress
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - MYSQL_PASSWORD=wordpress
    volumes:
      - wordpress-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-pwordpress"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - temporal-network

  wordpress:
    build:
      context: ..
      dockerfile: wordpress/Dockerfile
    ports:
      - '8081:80'
    environment:
      - WORDPRESS_DB_HOST=wordpress-db
      - WORDPRESS_DB_PORT=3306
      - WORDPRESS_DB_USER=wordpress
      - WORDPRESS_DB_PASSWORD=wordpress
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_SITE_URL=http://localhost:8081
      - WORDPRESS_SITE_TITLE=Temporal WordPress Demo
      - WORDPRESS_ADMIN_USER=admin
      - WORDPRESS_ADMIN_PASSWORD=admin
      - WORDPRESS_ADMIN_EMAIL=admin@example.com
      - TEMPORAL_REST_URL=http://rest-proxy:4000
    depends_on:
      wordpress-db:
        condition: service_healthy
    volumes:
      - ../wordpress/wp-temporal-cms:/var/www/html/wp-content/plugins/wp-temporal-cms
      - ./wordpress-apache.conf:/etc/apache2/conf-enabled/servername.conf
    networks:
      - temporal-network

  temporal:
    depends_on:
      postgresql:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "temporal", "operator", "cluster", "health"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  temporal-admin-tools:
    depends_on:
      temporal:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "temporal", "operator", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  drupal-db-data:
  wordpress-db-data:
  worker-node-modules:

networks:
  temporal-network:
    external: true
    name: temporal-network
